# scolengo-api

[![view on npm](http://img.shields.io/npm/v/scolengo-api.svg?style=flat-square)](https://www.npmjs.org/package/scolengo-api)
![GitHub CI](https://github.com/maelgangloff/scolengo-api/actions/workflows/CI.yml/badge.svg)
[![Discord](https://img.shields.io/discord/1095829734211977276?label=Discord&style=flat-square)](https://discord.gg/9u69mxsFT6)
[![npm](https://img.shields.io/npm/dm/scolengo-api?style=flat-square)](https://npm-stat.com/charts.html?package=scolengo-api)

Support non officiel de l'API Skolengo. Il s'agit de l'API utilis√©e par la nouvelle application mobile √©ponyme. Ce module est destin√© √† devenir le successeur de [kdecole-api](https://github.com/maelgangloff/kdecole-api) dans l'√©ventualit√© o√π l'acc√®s √† l'ancienne API serait d√©finitivement clos.  
Pour utiliser cette librairie, il est n√©cessaire de s'authentifier aupr√®s des serveurs de Skolengo. Pour obtenir des jetons de connexion, vous pouvez utiliser [scolengo-token](https://github.com/maelgangloff/scolengo-token).  

Pour participer et se tenir inform√©, **rejoins le serveur Discord: https://discord.gg/9u69mxsFT6**  

## Remarques importantes:
- Il est clairement mentionn√© que cette librairie est n'est pas officielle.
- Ce module n'est pas une contrefa√ßon car il n'existe pas de module similaire √©dit√© officiellement.
- Les utilisateurs ne peuvent acc√©der qu'√† leurs propres donn√©es. Ils sont soumis au m√™me processus d'authentification que celui impl√©ment√© dans l'application.
- Les donn√©es des utilisateurs ne sont pas davantage expos√©es puisqu'un utilisateur ne peut acc√©der qu'√† ses propres donn√©es. Personne n'a le contr√¥le sur cette limitation qui est inh√©rente au fonctionnement de l'API des serveurs de Skolengo.
- Cette librairie ne se suffit pas √† elle-m√™me pour fonctionner. Il est n√©cessaire de l'importer dans un projet et l'utilisateur est le seul responsable de son code et des √©ventuelles cons√©quences.
- Tout utilisateur de cette librairie a *a priori* lu l'enti√®ret√© du fichier de licence GPLv3 disponible publiquement [LICENSE](https://github.com/maelgangloff/scolengo-api/blob/master/LICENSE) ainsi que de ce pr√©sent fichier de pr√©sentation.
- Tout utilisateur de cette librairie a *a priori* lu l'enti√®ret√© du code de ce projet avant toute utilisation.
- Eu √©gard l'ensemble de ces remarques, les contributeurs et *a fortiori* l'auteur du projet ne peuvent √™tre tenus comme responsables de tout dommage potentiel.  

## Liste des ENT utilisant le CMS Skolengo :
| Nom usuel de l'ENT           | Code ENT | URL OpenID Connect Discovery                               |
|------------------------------|----------|------------------------------------------------------------|
| Mon Bureau Num√©rique         | gdest    | https://sso.monbureaunumerique.fr/oidc/.well-known         |
| Mon ENT Occitanie            | entmip   | https://sso.mon-ent-occitanie.fr/oidc/.well-known          |
| Ars√®ne 76                    | cg76     | https://sso.arsene76.fr/oidc/.well-known                   |
| ENT27                        | cg27     | https://sso.ent27.fr/oidc/.well-known                      |
| ENT Creuse                   | cg23     | https://sso.entcreuse.fr/oidc/.well-known                  |
| ENT Auvergne-Rh√¥ne-Alpes     | rra      | https://sso.ent.auvergnerhonealpes.fr/oidc/.well-known     |
| Agora 06                     | cg06     | https://sso.agora06.fr/oidc/.well-known                    |
| CyberColl√®ges 42             | cg42     | https://sso.cybercolleges42.fr/oidc/.well-known            |
| eColl√®ge 31 Haute-Garonne    | cg31     | https://sso.ecollege.haute-garonne.fr/oidc/.well-known     |
| Mon coll√®ge en Val d'Oise    | cg95     | https://sso.moncollege.valdoise.fr/oidc/.well-known        |
| Webcoll√®ge Seine-Saint-Denis | cg93     | https://sso.webcollege.seinesaintdenis.fr/oidc/.well-known |
| Eclat-BFC                    | bfc      | https://sso.eclat-bfc.fr/oidc/.well-known                  |
| @ucoll√®ge84                  | cg84     | https://sso.aucollege84.vaucluse.fr/oidc/.well-known       |
| ENT Val de Marne             | cg94     | https://sso.entvaldemarne.skolengo.com/oidc/.well-known    |
| Skolengo-√âcoles primaires    | metab1d  | https://sso.skolengo.com/oidc/.well-known                  |
| Skolengo-Coll√®ges et Lyc√©es  | mpdl     | https://sso.pdl.kosmoseducation.com/oidc/.well-known       |
| AEFE                         | metab    | https://sso1.skolengo.com/oidc/.well-known                 |
| AEFE Am√©rique - Pacifique    | metabam  | https://sso2.skolengo.com/oidc/.well-known                 |
| Schulportal Ostbelgien       | cgb      | https://sso.schulen.be/oidc/.well-known                    |

<a name="Skolengo"></a>

## Skolengo
**Kind**: global class  

* [Skolengo](#Skolengo)
    * [new Skolengo(oidClient, school, tokenSet)](#new_Skolengo_new)
    * _instance_
        * [.getUserInfo(userId)](#Skolengo+getUserInfo)
        * [.getEvaluationSettings(studentId)](#Skolengo+getEvaluationSettings)
        * [.getEvaluation(studentId, periodId)](#Skolengo+getEvaluation)
        * [.getEvaluationDetail(studentId, markId)](#Skolengo+getEvaluationDetail)
        * [.getHomeworkAssignments(studentId, startDate, endDate)](#Skolengo+getHomeworkAssignments)
        * [.getHomeworkAssignment(studentId, homeworkId)](#Skolengo+getHomeworkAssignment)
        * [.patchHomeWorkAssignment(studentId, homeworkId, attributes)](#Skolengo+patchHomeWorkAssignment)
        * [.getAgenda(studentId, startDate, endDate)](#Skolengo+getAgenda)
        * [.getLesson(studentId, lessonId)](#Skolengo+getLesson)
        * [.getSchoolInfos()](#Skolengo+getSchoolInfos)
        * [.getSchoolInfo(schoolInfoId)](#Skolengo+getSchoolInfo)
        * [.getUsersMailSettings(userId)](#Skolengo+getUsersMailSettings)
        * [.getCommunicationsFolder(folderId, limit, offset)](#Skolengo+getCommunicationsFolder)
        * [.getCommunicationParticipations(communicationId)](#Skolengo+getCommunicationParticipations)
    * _static_
        * [.revokeToken(oidClient, token)](#Skolengo.revokeToken)
        * [.getAppCurrentConfig()](#Skolengo.getAppCurrentConfig)
        * [.searchSchool(text, limit, offset)](#Skolengo.searchSchool)
        * [.getOIDClient(school)](#Skolengo.getOIDClient)
        * [.fromConfigObject(config)](#Skolengo.fromConfigObject)

<a name="new_Skolengo_new"></a>

### new Skolengo(oidClient, school, tokenSet)
Il est possible de s'authentifier en poss√©dant au pr√©lable des jetons OAuth 2.0


| Param | Type | Description |
| --- | --- | --- |
| oidClient | <code>Client</code> | Un client OpenID Connect |
| school | <code>School</code> | Etablissement |
| tokenSet | <code>TokenSet</code> | Jetons d'authentification OpenID Connect |

**Example**  
```js
const {Skolengo, TokenSet} = require('scolengo-api')

Skolengo.searchSchool('Lyc√©e Louise Weiss').then(async schools => {
  if(!schools.data.length) throw new Error("Aucun √©tablissement n'a √©t√© trouv√©.")
  const school = schools.data[0]
  const oidClient = await Skolengo.getOIDClient(school)

  // üö® ATTENTION: Ne communiquez jamais vos jetons √† un tiers. Ils vous sont strictement personnels. Si vous pensez que vos jetons ont √©t√© d√©rob√©s, r√©voquez-les imm√©diatement.

  const tokenSet = new TokenSet({
    access_token: 'ACCESS_TOKEN',
    id_token: 'ID_TOKEN',
    refresh_token: 'REFRESH_TOKEN',
    token_type: 'bearer',
    expires_at: 1681486899,
    scope: 'openid'
  })

  const user = new Skolengo(oidClient, school, tokenSet)
  const infoUser = await user.getUserInfo()
  console.log(`Correctement authentifi√© sous l'identifiant ${infoUser.data.id}`)
})

```
<a name="Skolengo+getUserInfo"></a>

### skolengo.getUserInfo(userId)
Informations sur l'utilisateur actuellement authentifi√© (nom, pr√©nom, date de naissance, adresse postale, courriel, t√©l√©phone, permissions, ...)

**Kind**: instance method of [<code>Skolengo</code>](#Skolengo)  

| Param | Type | Description |
| --- | --- | --- |
| userId | <code>string</code> \| <code>undefined</code> | Identifiant de l'utilisateur |

<a name="Skolengo+getEvaluationSettings"></a>

### skolengo.getEvaluationSettings(studentId)
Statut des services d'√©valuation (identifiant des p√©riodes, ...)

**Kind**: instance method of [<code>Skolengo</code>](#Skolengo)  

| Param | Type | Description |
| --- | --- | --- |
| studentId | <code>string</code> | Identifiant d'un √©tudiant |

<a name="Skolengo+getEvaluation"></a>

### skolengo.getEvaluation(studentId, periodId)
R√©cup√©rer les notes d'un √©tudiant sur une p√©riode

**Kind**: instance method of [<code>Skolengo</code>](#Skolengo)  

| Param | Type | Description |
| --- | --- | --- |
| studentId | <code>string</code> | Identifiant d'un √©tudiant |
| periodId | <code>string</code> | Identifiant de la p√©riode de notation |

<a name="Skolengo+getEvaluationDetail"></a>

### skolengo.getEvaluationDetail(studentId, markId)
R√©cup√©rer le d√©tail d'une note d'un √©tudiant

**Kind**: instance method of [<code>Skolengo</code>](#Skolengo)  

| Param | Type | Description |
| --- | --- | --- |
| studentId | <code>string</code> | Identifiant d'un √©tudiant |
| markId | <code>string</code> | Identifiant de la note |

<a name="Skolengo+getHomeworkAssignments"></a>

### skolengo.getHomeworkAssignments(studentId, startDate, endDate)
R√©cup√©rer les devoirs d'un √©tudiant

**Kind**: instance method of [<code>Skolengo</code>](#Skolengo)  

| Param | Type | Description |
| --- | --- | --- |
| studentId | <code>string</code> | Identifiant d'un √©tudiant |
| startDate | <code>string</code> | Date de d√©but - Format : YYYY-MM-DD |
| endDate | <code>string</code> | Date de fin - Format : YYYY-MM-DD |

<a name="Skolengo+getHomeworkAssignment"></a>

### skolengo.getHomeworkAssignment(studentId, homeworkId)
R√©cup√©rer les donn√©es d'un devoir

**Kind**: instance method of [<code>Skolengo</code>](#Skolengo)  

| Param | Type | Description |
| --- | --- | --- |
| studentId | <code>string</code> | Identifiant d'un √©tudiant |
| homeworkId | <code>string</code> | Identifiant du devoir |

<a name="Skolengo+patchHomeWorkAssignment"></a>

### skolengo.patchHomeWorkAssignment(studentId, homeworkId, attributes)
Modifier le statut d'un travail √† faire

**Kind**: instance method of [<code>Skolengo</code>](#Skolengo)  

| Param | Type | Description |
| --- | --- | --- |
| studentId | <code>string</code> | Identifiant d'un √©tudiant |
| homeworkId | <code>string</code> | Identifiant d'un devoir |
| attributes | <code>Homework</code> | Attributs du devoir √† modifier |

**Example**  
```js
const {Skolengo} = require('scolengo-api')

const user = await Skolengo.fromConfigObject(config)
user.patchHomeWorkAssignment('ESKO-P-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx', '123456', { done: true }).then(hmw => {
  console.log(`Le travail "${hmw.data.attributes.title}" a √©t√© marqu√© ${hmw.data.attributes.done ? 'fait' : '√† faire'}.`)
})
```
<a name="Skolengo+getAgenda"></a>

### skolengo.getAgenda(studentId, startDate, endDate)
R√©cup√©rer l'agenda d'un √©tudiant

**Kind**: instance method of [<code>Skolengo</code>](#Skolengo)  

| Param | Type | Description |
| --- | --- | --- |
| studentId | <code>string</code> | Identifiant d'un √©tudiant |
| startDate | <code>string</code> | Date de d√©but - Format : YYYY-MM-DD |
| endDate | <code>string</code> | Date de fin - Format : YYYY-MM-DD |

<a name="Skolengo+getLesson"></a>

### skolengo.getLesson(studentId, lessonId)
R√©cup√©rer les donn√©es d'un cours/le√ßon

**Kind**: instance method of [<code>Skolengo</code>](#Skolengo)  

| Param | Type | Description |
| --- | --- | --- |
| studentId | <code>string</code> | Identifiant d'un √©tudiant |
| lessonId | <code>string</code> | Identifiant d'un cours/le√ßon |

<a name="Skolengo+getSchoolInfos"></a>

### skolengo.getSchoolInfos()
R√©cup√©rer toutes les actualit√©s de l'√©tablissement

**Kind**: instance method of [<code>Skolengo</code>](#Skolengo)  
<a name="Skolengo+getSchoolInfo"></a>

### skolengo.getSchoolInfo(schoolInfoId)
R√©cup√©rer une actualit√© de l'√©tablissement

**Kind**: instance method of [<code>Skolengo</code>](#Skolengo)  

| Param | Type | Description |
| --- | --- | --- |
| schoolInfoId | <code>string</code> | Identifiant d'une actualit√© |

<a name="Skolengo+getUsersMailSettings"></a>

### skolengo.getUsersMailSettings(userId)
R√©cup√©rer les informations du service de communication (identifiants des dossiers, ...)

**Kind**: instance method of [<code>Skolengo</code>](#Skolengo)  

| Param | Type | Description |
| --- | --- | --- |
| userId | <code>string</code> \| <code>undefined</code> | Identifiant d'un utilisateur |

<a name="Skolengo+getCommunicationsFolder"></a>

### skolengo.getCommunicationsFolder(folderId, limit, offset)
R√©cup√©rer les communication d'un dossier

**Kind**: instance method of [<code>Skolengo</code>](#Skolengo)  

| Param | Type | Default | Description |
| --- | --- | --- | --- |
| folderId | <code>string</code> |  | Identifiant d'un dossier |
| limit | <code>number</code> \| <code>undefined</code> | <code>10</code> | Limite |
| offset | <code>number</code> \| <code>undefined</code> | <code>0</code> | Offset |

<a name="Skolengo+getCommunicationParticipations"></a>

### skolengo.getCommunicationParticipations(communicationId)
R√©cup√©rer les participations d'un fil de discussion (communication)

**Kind**: instance method of [<code>Skolengo</code>](#Skolengo)  

| Param | Type | Description |
| --- | --- | --- |
| communicationId | <code>string</code> | Identifiant d'une communication |

<a name="Skolengo.revokeToken"></a>

### Skolengo.revokeToken(oidClient, token)
R√©voquer un jeton

**Kind**: static method of [<code>Skolengo</code>](#Skolengo)  

| Param | Type | Description |
| --- | --- | --- |
| oidClient | <code>Client</code> | Un client OpenID Connect |
| token | <code>string</code> | Un jeton |

<a name="Skolengo.getAppCurrentConfig"></a>

### Skolengo.getAppCurrentConfig()
Configuration actuelle de l'application mobile (derni√®re version d√©ploy√©e, derni√®re version support√©e, ...)

**Kind**: static method of [<code>Skolengo</code>](#Skolengo)  
**Example**  
```js
const {Skolengo} = require('scolengo-api')

Skolengo.getAppCurrentConfig().then(config => {
  console.log(`Derni√®re version d√©ploy√©e: ${config.data.attributes.latestDeployedSkoAppVersion}`)
  console.log(`Derni√®re version support√©e: ${config.data.attributes.latestSupportedSkoAppVersion}`)
})
```
<a name="Skolengo.searchSchool"></a>

### Skolengo.searchSchool(text, limit, offset)
Rechercher un √©tablissement scolaire

**Kind**: static method of [<code>Skolengo</code>](#Skolengo)  

| Param | Type | Default | Description |
| --- | --- | --- | --- |
| text | <code>string</code> |  | Le nom partiel de l'√©tablissement |
| limit | <code>number</code> | <code>10</code> | Nombre max d'√©l√©ments |
| offset | <code>number</code> | <code>0</code> | Offset |

**Example**  
```js
const {Skolengo} = require('scolengo-api')

Skolengo.searchSchool('Lyc√©e Louise Weiss').then(schools => {
  console.log(schools)
})
```
<a name="Skolengo.getOIDClient"></a>

### Skolengo.getOIDClient(school)
Cr√©er un client OpenID Connect permettant l'obtention des jetons (refresh token et access token)

**Kind**: static method of [<code>Skolengo</code>](#Skolengo)  

| Param | Type | Description |
| --- | --- | --- |
| school | <code>School</code> | L'√©tablissement scolaire |

**Example**  
```js
const {Skolengo} = require('scolengo-api')

Skolengo.searchSchool('Lyc√©e Louise Weiss').then(async schools => {
  if(!schools.data.length) throw new Error("Aucun √©tablissement n'a √©t√© trouv√©.")
  const school = schools.data[0]
  const oidClient = await Skolengo.getOIDClient(school, 'skoapp-prod://sign-in-callback')
  console.log(oidClient.authorizationUrl())
  // Lorsque l'authentification est effectu√©e, le CAS redirige vers le callback indiqu√© avec le code. Ce code permet d'obtenir les refresh token et access token (cf. m√©canismes OAuth 2.0 et OID Connect)
})
```
```js
const {Skolengo} = require('scolengo-api')

Skolengo.searchSchool('Lyc√©e Louise Weiss').then(async schools => {
  if(!schools.data.length) throw new Error("Aucun √©tablissement n'a √©t√© trouv√©.")
  const school = schools.data[0]
  const oidClient = await Skolengo.getOIDClient(school, 'skoapp-prod://sign-in-callback')

  const params = oidClient.callbackParams('skoapp-prod://sign-in-callback?code=OC-9999-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx-X')
  const tokenSet = await oidClient.callback('skoapp-prod://sign-in-callback', params)
  // üö® ATTENTION: Ne communiquez jamais vos jetons √† un tiers. Ils vous sont strictement personnels. Si vous pensez que vos jetons ont √©t√© d√©rob√©s, r√©voquez-les imm√©diatement.

  const user = new Skolengo(oidClient, school, tokenSet)
  const infoUser = await user.getUserInfo()
  console.log(`Correctement authentifi√© sous l'identifiant ${infoUser.data.id}`)
})
```
<a name="Skolengo.fromConfigObject"></a>

### Skolengo.fromConfigObject(config)
Cr√©er un client Skolengo √† partir d'un objet contenant les informations d'authentification.
Cet objet de configuration peut √™tre g√©n√©r√© √† partir de l'utilitaire [scolengo-token](https://github.com/maelgangloff/scolengo-token)

**Kind**: static method of [<code>Skolengo</code>](#Skolengo)  

| Param | Type | Description |
| --- | --- | --- |
| config | <code>AuthConfig</code> | Informations d'authentification |

**Example**  
```js
const {Skolengo} = require('scolengo-api')
const config = require('./config.json')
const user = await Skolengo.fromConfigObject(config)
```
```js
const {Skolengo} = require('scolengo-api')

// üö® ATTENTION: Ne communiquez jamais vos jetons √† un tiers. Ils vous sont strictement personnels. Si vous pensez que vos jetons ont √©t√© d√©rob√©s, r√©voquez-les imm√©diatement.
const config = {
  "tokenSet": {
    "access_token": "<access_token_here>",
    "id_token": "<id_token_here>",
    "refresh_token": "RT-<refresh_token_here>",
    "token_type": "bearer",
    "expires_at": 1234567890,
    "scope": "openid"
  },
  "school": {
    "id": "SKO-E-<school_id>",
    "type": "school",
    "attributes": {
      "name": "<school_name>",
      "addressLine1": "<school_address>",
      "addressLine2": null,
      "addressLine3": null,
      "zipCode": "<school_zip_code>",
      "city": "<school_city>",
      "country": "France",
      "homePageUrl": "<cas_login_url>",
      "emsCode": "<school_ems_code>",
      "emsOIDCWellKnownUrl": "<school_ems_oidc_well_known_url>"
    }
  }
}
Skolengo.fromConfigObject(config).then(async user => {
  const infoUser = await user.getUserInfo()
  console.log(`Correctement authentifi√© sous l'identifiant ${infoUser.data.id}`)
})
```
